#pragma once

#include "ST7735_TFT.h"

// display dimensions
#define HEIGHT 128
#define WIDTH  160


// text overlay buffer
#define TEXT_OVERLAY_BUF 416 
#define ST_TEXT_OVERLAY 0x20

/* 
 * Display
 * Will be rendered using DMA eventually
 */
uint16_t display[HEIGHT * WIDTH];

// supports 10x20 text overlay
uint8_t text_overlay[TEXT_OVERLAY_BUF + 1] = { '0' };

/*
 * bitmap array
 * ASCII codes ST_TEXT_OVERLAY-0x7E can be displayed
 * so subtract ST_TEXT_OVERLAY
 * for the bitmap for the character
 * these are 6x7 rotated -90 degrees and flipped
 */
char *bitmaps[] = {
		"0000000" // (space)
		"0000000"
		"0000000"
		"0000000"
		"0000000"
		"0000000",

		"0000000" // !
		"0000000"
		"1111010"
		"0000000"
		"0000000"
		"0000000",

		"0110000" // "
		"0100000"
		"0000000"
		"0110000"
		"0100000"
		"0000000", 

		"0100100" // #
		"1111110"
		"0100100"
		"1111110"
		"0100100"
		"0000000",

		"0010000" // $
		"0101010"
		"1111110"
		"0101010"
		"0000100"
		"0000000",

		"0010010" // %
		"0000100"
		"0001000"
		"0010000"
		"0100100"
		"0000000",

		"0101100" // &
		"1010010"
		"1010010"
		"0101100"
		"0010100"
		"0100010",

		"0000000" // '
		"0000000"
		"0110000"
		"0000000"
		"0000000"
		"0000000",

		"0000000" // (
		"0011000"
		"0100100"
		"1000010"
		"0000000"
		"0000000",

		"0000000" // )
		"1000010"
		"0100100"
		"0011000"
		"0000000"
		"0000000",

		"0000000" // *
		"0011100"
		"0011100"
		"0011100"
		"0000000"
		"0000000",

		"0000000" // +
		"0001000"
		"0011100"
		"0001000"
		"0000000"
		"0000000",

		"0000000" // ,
		"0000001"
		"0000010"
		"0000000"
		"0000000"
		"0000000",

		"0000000" // -
		"0001000"
		"0001000"
		"0001000"
		"0000000"
		"0000000",

		"0000000" // .
		"0000110"
		"0000110"
		"0000000"
		"0000000"
		"0000000",

		"0000000" // /
		"0000110"
		"0011000"
		"1100000"
		"0000000"
		"0000000",

		"0111100" // 0
		"1001110"
		"1011010"
		"1100010"
		"0111100"
		"0000000",

		"0000010" // 1
		"0100010"
		"1111110"
		"0000010"
		"0000010"
		"0000000",

		"0100010" // 2
		"1000110"
		"1001010"
		"1010010"
		"0100010"
		"0000000",

		"0100100" // 3
		"1000010"
		"1010010"
		"1010010"
		"0101100"
		"0000000",

		"1110000" // 4
		"0010000"
		"0010000"
		"0010000"
		"1111110"
		"0000000",

		"1110010" // 5
		"1010010"
		"1010010"
		"1010010"
		"1001100"
		"0000000",

		"0100100" // 6
		"1001010"
		"1001010"
		"1001010"
		"0111100"
		"0000000",

		"1000010" // 7
		"1000100"
		"1001000"
		"1010000"
		"1100000"
		"0000000",

		"0101100" // 8
		"1010010"
		"1010010"
		"1010010"
		"0101100"
		"0000000",

		"0100000" // 9
		"1010010"
		"1010010"
		"1010010"
		"0111100"
		"0000000",

		"0000000" // :
		"0000000"
		"0110110"
		"0000000"
		"0000000"
		"0000000",

		"0000000" // ;
		"0000010"
		"0110100"
		"0000000"
		"0000000"
		"0000000",

		"0000000" // <
		"0001000"
		"0010100"
		"0100010"
		"0000000"
		"0000000",

		"0000000" // =
		"0010100"
		"0010100"
		"0010100"
		"0000000"
		"0000000",

		"0000000" // >
		"0100010"
		"0010100"
		"0001000"
		"0000000"
		"0000000",

		"0000000" // ?
		"0100000"
		"1001010"
		"1010000"
		"0100000"
		"0000000",

		"0011100" // @
		"0110010"
		"0101010"
		"0100100"
		"0010000"
		"0000000",

		"1111110" // A
		"1010000"
		"1010000"
		"1010000"
		"1111110"
		"0000000",

		"1111110" // B
		"1010010"
		"1010010"
		"1010010"
		"0101100"
		"0000000",

		"0111100" // C
		"1000010"
		"1000010"
		"1000010"
		"0100100"
		"0000000",

		"1111110" // D
		"1000010"
		"1000010"
		"0100100"
		"0011000"
		"0000000",

		"1111110" // E
		"1010010"
		"1010010"
		"1010010"
		"1010010"
		"0000000",	

		"1111110" // F
		"1010000"
		"10100o0"
		"1010000"
		"1000000"
		"0000000",

		"0111100" // G
		"1000010"
		"1001010"
		"1001010"
		"0101100"
		"0000000",

		"1111110" // H
		"0010000"
		"0010000"
		"0010000"
		"1111110"
		"0000000",

		"1000010" // I
		"1000010"
		"1111110"
		"1000010"
		"1000010"
		"0000000",

		"1000010" // J
		"1000010"
		"1111100"
		"1000000"
		"1000000"
		"0000000",

		"1111110" // K
		"0010000"
		"0010000"
		"0101000"
		"1000110"
		"0000000",

		"1111110" // L
		"0000010"
		"0000010"
		"0000010"
		"0000010"
		"0000000",

		"1111110" // M
		"0100000"
		"0010000"
		"0100000"
		"1111110"
		"0000000",

		"1111110" // N
		"0100000"
		"0010000"
		"0001000"
		"1111110"
		"0000000",

		"0111100" // O
		"1000010"
		"1000010"
		"1000010"
		"0111100"
		"0000000",

		"1111110" // P
		"1010000"
		"1010000"
		"1010000"
		"0100000"
		"0000000",

		"0111000" // Q
		"1000100"
		"1001100"
		"1000100"
		"0111010"
		"0000000",

		"1111110" // R
		"1010000"
		"1011000"
		"1010100"
		"0100010"
		"0000000",

		"0100000" // S
		"1010010"
		"1010010"
		"1010010"
		"0001100"
		"0000000",

		"1000000" // T
		"1000000"
		"1111110"
		"1000000"
		"1000000"
		"0000000",

		"1111100" // U
		"0000010"
		"0000010"
		"0000010"
		"1111100"
		"0000000",

		"1100000" // V
		"0011100"
		"0000010"
		"0011100"
		"1100000"
		"0000000",

		"1111110" // W
		"0000100"
		"0001000"
		"0000100"
		"1111110"
		"0000000",

		"1000010" // X
		"0100100"
		"0011000"
		"0100100"
		"1000010"
		"0000000",

		"1000000" // Y
		"0100000"
		"0011110"
		"0100000"
		"1000000"
		"0000000",

		"1000010" // Z
		"1100010"
		"1010010"
		"1001010"
		"1000110"
		"0000000",

		"0000000" // [
		"1111111"
		"1000001"
		"1000001"
		"0000000"
		"0000000",

		"0000000" /* \ */
		"1100000"
		"0011000"
		"0000110"
		"0000000"
		"0000000",

		"0000000" // ]
		"1000001"
		"1000001"
		"1111111"
		"0000000"
		"0000000",

		"0000000" // ^
		"0100000"
		"1000000"
		"0100000"
		"0000000"
		"0000000",

		"0000010" // _
		"0000010"
		"0000010"
		"0000010"
		"0000010"
		"0000000",

		"0000000" // `
		"1000000"
		"0100000"
		"0010000"
		"0000000"
		"0000000",

		"0011100" // a
		"0100010"
		"0100010"
		"0100010"
		"0111110"
		"0000000",

		"1111110" // b
		"0100010"
		"0100010"
		"0100010"
		"0011100"
		"0000000",

		"0011100" // c
		"0100010"
		"0100010"
		"0100010"
		"0100010"
		"0000000",

		"0011100" // d
		"0100010"
		"0100010"
		"0100010"
		"1111110"
		"0000000",

		"0011100" // e
		"0101010"
		"0101010"
		"0101010"
		"0010010"
		"0000000",

		"0011110" // f
		"0110000"
		"1010000"
		"1010000"
		"1000000"
		"0000000",

		"0001000" // g
		"0010101"
		"0010101"
		"0010101"
		"0001110"
		"0000000",

		"1111110" // h
		"0010000"
		"0010000"
		"0010000"
		"0001110"
		"0000000",

		"0000000" // i
		"0000000"
		"1011110"
		"0000000"
		"0000000"
		"0000000",

		"0000001" // j
		"0000001"
		"1011110"
		"0000000"
		"0000000"
		"0000000",

		"1111110" // k
		"0001000"
		"0010100"
		"0000010"
		"0000000"
		"0000000",

		"0000000" // l
		"0000000"
		"1111110"
		"0000000"
		"0000000"
		"0000000",

		"0001110" // m
		"0010000"
		"0001110"
		"0010000"
		"0001110"
		"0000000",

		"0001110" // n
		"0010000"
		"0010000"
		"0010000"
		"0001110"
		"0000000",

		"0001100" // o
		"0010010"
		"0010010"
		"0010010"
		"0001100"
		"0000000",

		"0011111" // p
		"0010100"
		"0010100"
		"0010100"
		"0001000"
		"0000000",

		"0001000" // q
		"0010100"
		"0010100"
		"0010110"
		"0001001"
		"0000000",
		
		"0000000" // r
		"0011110"
		"0001000"
		"0010000"
		"0000000"
		"0000000",

		"0010000" // s
		"0101010"
		"0101010"
		"0101010"
		"0000100"
		"0000000",

		"0010000" // t
		"0010000"
		"1111100"
		"0010010"
		"0010000"
		"0000000",

		"0111100" // u
		"0000010"
		"0000010"
		"0000010"
		"0111100"
		"0000000",

		"0011000" // v
		"0000100"
		"0000010"
		"0000100"
		"0011000"
		"0000000",

		"0011100" // w
		"0000010"
		"0011100"
		"0000010"
		"0011100"
		"0000000",

		"0100010" // x
		"0010100"
		"0001000"
		"0010100"
		"0100010"
		"0000000",

		"0000010" // y
		"0010001"
		"0001001"
		"0000110"
		"0011000"
		"0000000",

		"0010010" // z
		"0010110"
		"0011010"
		"0010010"
		"0000000"
		"0000000"
};


/*
 * clear the display
 * sets a bunch of white pixels
 */
void
display_clear(void) 
{
	for (uint16_t i = 0; i < HEIGHT * WIDTH; i++) {
		display[i] = ST7735_WHITE;
	}
}

/*
 * manually render
 * uses cpu time and is inefficient
 */
void
render(void) 
{
	spi_write_blocking(SPI_TFT_PORT, (uint8_t *)display, HEIGHT * WIDTH * 2);
} 

/* 
 * puts the text overlay on top of the buffer
 */
void 
render_text_overlay(void) 
{
	// character in overlay
	for (uint16_t i = 0; i < TEXT_OVERLAY_BUF; i++) {
		// pixel in bitmap
		for (uint8_t j = 0; j < 6; j++) {
			for (uint8_t k = 0; k < 7; k++) {
				// hopefully the compiler optimizes this
				display[
					(k + HEIGHT * j) +			// pixel in bitmap
					((i % 26) * HEIGHT * 6) +	// char row in text overlay
					((i / 26) * 8) +			// char col in text overlay
					HEIGHT * 2 + 1				// start offset
				] = (bitmaps[text_overlay[i] - ST_TEXT_OVERLAY][k + j * 7] == '0') ? ST7735_WHITE : ST7735_BLACK;
			}
		}
	} 
}